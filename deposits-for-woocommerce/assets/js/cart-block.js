!function () { "use strict"; const t = { isUpdating: !1, componentMounted: !1, debounceTimeouts: new Map, lastUpdateTime: 0 }, e = (t, e = "info") => { if (window.baynaBlocksData?.debug_mode) { const n = "coupon" === e ? "[COUPON-DEBUG]" : `[${e.toUpperCase()}]`; console.log(`[CART-BLOCKS-FREE] ${n} ${t}`) } }, n = t => { e(t, "coupon") }, o = (e, n, o) => function (...a) { t.debounceTimeouts.has(o) && clearTimeout(t.debounceTimeouts.get(o)); const c = setTimeout((() => { t.debounceTimeouts.delete(o), e.apply(this, a) }), n); t.debounceTimeouts.set(o, c) }, a = t => { if (!t || 0 === t) return "$0.00"; try { const e = window.baynaBlocksData?.currency; return e && window.Intl ? new Intl.NumberFormat("en-US", { style: "currency", currency: e.code || "USD", minimumFractionDigits: e.precision || 2 }).format(parseFloat(t)) : "$" + parseFloat(t).toFixed(2) } catch (e) { return "$" + parseFloat(t || 0).toFixed(2) } }, c = t => { const n = a(t);[".wc-block-components-totals-footer-item .wc-block-formatted-money-amount", ".wc-block-cart__totals .wc-block-components-totals-footer-item .wc-block-formatted-money-amount"].forEach((t => { document.querySelectorAll(t).forEach((t => { const o = t.closest(".wc-block-components-totals-item, .wc-block-components-totals-footer-item"), a = o?.textContent?.toLowerCase() || "", c = a.includes("subtotal"), s = a.includes("shipping") || a.includes("flat rate"), r = a.includes("tax"); c || s || r || (t.textContent = n, e(`Updated cart total to: ${n}`)) })) })) }, s = t => { if (!t || !Array.isArray(t)) return; const n = document.querySelectorAll(".wc-block-cart-item, .wc-block-cart-items__row"); e(`Injecting deposit info for ${t.length} items into ${n.length} cart elements`), n.forEach(((e, n) => { const o = t[n]; if (!o || !o.has_deposit) { const t = e.querySelector(".bayna-deposit-info"); return void (t && t.remove()) } const c = e.querySelector(".bayna-deposit-info"); c && c.remove(); const s = e.querySelector(".wc-block-cart-item__product"); if (!s) return; const r = document.createElement("div"); r.className = "bayna-deposit-info", r.innerHTML = `\n                <div class="bayna-deposit-row">\n                    <span class="bayna-deposit-label">Deposit:</span>\n                    <span class="bayna-deposit-amount">${a(o.deposit_amount)}</span>\n                </div>\n                <div class="bayna-due-row">\n                    <span class="bayna-due-label">Due:</span>\n                    <span class="bayna-due-amount">${a(o.due_amount)}</span>\n                </div>\n            `, s.appendChild(r) })) }, r = { depositData: null, lastFetchTime: 0, fetchPromise: null, CACHE_DURATION: 3e4, isValid() { return this.depositData && Date.now() - this.lastFetchTime < this.CACHE_DURATION }, set(t) { this.depositData = t, this.lastFetchTime = Date.now(), window.currentCartDepositData = t }, clear() { this.depositData = null, this.lastFetchTime = 0, this.fetchPromise = null } }, i = async (o = !1) => { if (!o && r.isValid()) return e("Using cached deposit data"), r.depositData; if (r.fetchPromise) return e("Request already in progress, waiting..."), r.fetchPromise; try { t.isUpdating = !0, e("Fetching fresh deposit data"), n("Fetching cart data - potentially after coupon change"), r.fetchPromise = fetch(window.baynaBlocksData?.ajax_url, { method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body: new URLSearchParams({ action: "bayna_get_cart_deposit_data", nonce: window.baynaBlocksData?.ajax_nonce || "", page_context: "cart" }) }).then((t => t.json())); const o = await r.fetchPromise; return o.success && o.data ? (r.set(o.data), e("Fresh deposit data loaded and cached"), n(`New totals after fetch - Deposit: ${o.data.deposit_total}, Due: ${o.data.due_total}, Original: ${o.data.original_total}`), o.data) : (e("Invalid response from server", "error"), n("Failed to get valid cart data from server"), null) } catch (t) { return e("Error fetching deposit data: " + t.message, "error"), n("Error during cart data fetch: " + t.message), null } finally { t.isUpdating = !1, r.fetchPromise = null } }, l = () => { if (!window.wp?.plugins || !window.wc?.blocksCheckout) return void setTimeout(l, 100); e("Initializing cart blocks with coupon support"), n("Coupon debugging enabled for cart page"); const { registerPlugin: r } = window.wp.plugins, { ExperimentalOrderMeta: d } = window.wc.blocksCheckout, { __: m } = window.wp.i18n, { useEffect: u, useState: p, createElement: b } = window.wp.element, y = () => { const [r, l] = p(null), [d, y] = p(!0), w = { current: null }; w.current || (w.current = o((async () => { try { n("Debounced fetch triggered - likely due to coupon interaction"); const e = await i(!0); e && t.componentMounted && (l(e), n("Cart deposit data updated after debounced fetch"), e.has_deposit_items && c(e.deposit_total), e.items_details && setTimeout((() => { t.componentMounted && s(e.items_details) }), 100)) } catch (t) { e("Error in debounced cart update: " + t.message, "error"), n("Error in debounced update: " + t.message) } finally { t.componentMounted && y(!1) } }), 500, "fetchCartData")); const f = n => { if (!t.componentMounted) return; (n.target.closest(".wc-block-cart-item__quantity") || n.target.closest('[class*="quantity"]') || n.target.matches('input[type="number"]')) && (e("Quantity change detected"), setTimeout((() => { t.componentMounted && w.current() }), 800)) }, g = e => { if (!t.componentMounted) return; const o = e.target.matches(".wc-block-components-totals-coupon__button") || e.target.closest(".wc-block-components-totals-coupon__button"), a = e.target.matches(".wc-block-components-chip__remove") || e.target.closest(".wc-block-components-chip__remove"), c = e.target.closest(".wc-block-components-totals-coupon") || e.target.closest(".wc-block-coupon-form"); (o || a || c) && (n("COUPON ACTION DETECTED!"), n("Action type: " + (o ? "Apply Button" : a ? "Remove Chip" : "Coupon Related")), setTimeout((() => { t.componentMounted && w.current() }), 2e3)) }, h = e => { t.componentMounted && (e.target.matches(".wc-block-components-totals-coupon__form") || e.target.closest(".wc-block-components-totals-coupon__form")) && (n("COUPON FORM SUBMITTED!"), setTimeout((() => { t.componentMounted && w.current() }), 2e3)) }; return u((() => { t.componentMounted = !0, (async () => { try { const e = await i(); if (!t.componentMounted) return; e && (l(e), e.has_deposit_items && c(e.deposit_total), e.items_details && setTimeout((() => { t.componentMounted && s(e.items_details) }), 200)) } catch (t) { e("Error fetching cart deposit data: " + t.message, "error") } finally { t.componentMounted && y(!1) } })(), document.addEventListener("click", f, !0), document.addEventListener("click", g, !0), document.addEventListener("submit", h, !0), document.addEventListener("input", f, !0), document.addEventListener("wc_fragment_refresh", (() => { e("WC fragment refresh detected"), setTimeout((() => { t.componentMounted && w.current() }), 1500) })); const o = (() => { const o = document.querySelector(".wc-block-cart"); if (!o) return null; const a = new MutationObserver((o => { if (!t.componentMounted) return; let a = !1, c = 1e3; o.forEach((t => { if ("childList" === t.type && Array.from(t.addedNodes).concat(Array.from(t.removedNodes)).some((t => { if (1 === t.nodeType) { const e = t.classList?.contains("wc-block-cart-item") || t.querySelector?.(".wc-block-cart-item"), o = t.classList?.contains("wc-block-components-totals-coupon") || t.querySelector?.(".wc-block-components-totals-coupon") || t.classList?.contains("wc-block-components-totals-discount") || t.querySelector?.(".wc-block-components-totals-discount"), a = t.classList?.contains("wc-block-components-totals") || t.querySelector?.(".wc-block-components-totals"); return o && (c = 2500, n("Coupon-related DOM change detected via observer")), e || o || a } return !1 })) && (a = !0), "characterData" === t.type) { const e = t.target.parentElement; e && (e.closest(".wc-block-components-totals-discount") || e.closest(".wc-block-components-totals-total")) && (a = !0, c = 2e3, n("Totals text change detected")) } })), a && (e(`DOM changes detected, updating with ${c}ms delay`), setTimeout((() => { t.componentMounted && w.current() }), c)) })); return a.observe(o, { childList: !0, subtree: !0, characterData: !0 }), a })(); return () => { t.componentMounted = !1, document.removeEventListener("click", f, !0), document.removeEventListener("click", g, !0), document.removeEventListener("submit", h, !0), document.removeEventListener("input", f, !0), o && o.disconnect(), t.debounceTimeouts.forEach((t => clearTimeout(t))), t.debounceTimeouts.clear() } }), []), r?.has_deposit_items ? b("div", { className: "bayna-checkout-deposit-summary" }, [b("div", { key: "summary", className: "bayna-checkout-breakdown" }, [b("div", { key: "deposit-row", className: "bayna-checkout-summary-row wc-block-components-totals-item" }, [b("span", { key: "deposit-label", className: "wc-block-components-totals-item__label" }, window.baynaBlocksData?.deposit_labels?.deposit_amount || m("Total Deposit:", "deposits-for-woocommerce")), b("span", { key: "deposit-amount", className: "wc-block-formatted-money-amount wc-block-components-formatted-money-amount wc-block-components-totals-item__value" }, a(r.deposit_total))]), b("div", { key: "due-row", className: "bayna-checkout-summary-row wc-block-components-totals-item" }, [b("span", { key: "due-label", className: "wc-block-components-totals-item__label" }, window.baynaBlocksData?.deposit_labels?.due_payment || m("Total Due:", "deposits-for-woocommerce")), b("span", { key: "due-amount", className: "wc-block-formatted-money-amount wc-block-components-formatted-money-amount wc-block-components-totals-item__value" }, a(r.due_total))])])]) : null }; try { r("bayna-cart-deposit-summary", { render: () => b(d, {}, b(y)), scope: "woocommerce-checkout" }), e("Cart plugin with coupon support registered successfully"), n("Coupon integration ready for cart page") } catch (t) { e("Error registering cart plugin: " + t.message, "error") } }; if ("loading" === document.readyState ? document.addEventListener("DOMContentLoaded", l) : l(), !document.getElementById("bayna-cart-styles-free")) { const t = document.createElement("style"); t.id = "bayna-cart-styles-free", t.textContent = "\n            .bayna-checkout-summary-row {\n               padding: 4px 0;\n            }\n            \n            .bayna-cart-deposit-summary h3 {\n                font-size: 16px;\n        font-weight: 700;\n        text-transform: uppercase;\n                padding-bottom: 10px;\n                font-weight: 600;\n            }\n            \n            .bayna-deposit-breakdown {\n                margin-bottom: 10px;\n            }\n            \n            .bayna-summary-row {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                margin-bottom: 10px;\n                padding: 6px 0;\n                border-bottom: 1px solid #f5f5f5;\n            }\n            \n            .bayna-summary-row:last-of-type {\n                border-bottom: none;\n                margin-bottom: 0;\n            }\n            \n            .bayna-summary-total {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                margin-top: 14px;\n                padding-top: 14px;\n                border-top: 2px solid #0073aa;\n                font-weight: bold;\n                font-size: 1.05em;\n            }\n            \n            .bayna-deposit-info {\n               margin: 8px 0;\n    \n    display: inline-block;\n    \n    font-size: 0.9em;\n   \n    opacity: 0;\n    animation: baynaFadeIn 0.3s ease forwards;\n            }\n\n            @keyframes baynaFadeIn {\n                to { opacity: 1; }\n            }\n            \n            .bayna-deposit-row,\n            .bayna-due-row {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                margin-bottom: 4px;\n            }\n            \n            .bayna-due-row {\n                margin-bottom: 0;\n            }\n            \n            .bayna-deposit-label,\n            .bayna-due-label {\n                color: #495057;\n                font-weight: 600;\n                font-size: 0.85em;\n                text-transform: uppercase;\n                letter-spacing: 0.5px;\n            }\n            \n            .bayna-deposit-amount {\n                color: #28a745;\n                font-weight: 700;\n                font-size: 0.95em;\n            }\n            \n            .bayna-due-amount {\n                color: #6c757d;\n                font-weight: 600;\n                font-size: 0.95em;\n            }\n            \n            .bayna-loading {\n                text-align: center;\n                padding: 20px;\n                color: #666;\n                font-style: italic;\n            }\n\n            /* Highlight cart items with deposits */\n            .wc-block-cart-item:has(.bayna-deposit-info) {\n                background: rgba(0,115,170,0.02);\n                border-radius: 6px;\n                padding: 8px;\n                margin-bottom: 8px;\n                border: 1px solid rgba(0,115,170,0.1);\n            }\n            \n            @media (max-width: 768px) {\n                .bayna-cart-deposit-summary {\n                    padding: 14px;\n                    margin: 16px 0;\n                }\n                \n                .bayna-summary-row, \n                .bayna-summary-total {\n                    flex-direction: column;\n                    align-items: flex-start;\n                    gap: 4px;\n                }\n                \n                .bayna-deposit-info {\n                    padding: 8px;\n                    margin: 6px 0;\n                }\n                \n                .bayna-deposit-row,\n                .bayna-due-row {\n                    flex-direction: column;\n                    align-items: flex-start;\n                    gap: 2px;\n                }\n            }\n        ", document.head.appendChild(t) } window.testCouponElements = () => { n("=== COUPON ELEMENTS TEST ==="); const t = document.querySelector(".wc-block-components-totals-coupon__button"), e = document.querySelector(".wc-block-components-totals-coupon__form"), o = document.querySelectorAll(".wc-block-components-chip__remove"); n("Coupon Button: " + (t ? "FOUND" : "NOT FOUND")), n("Coupon Form: " + (e ? "FOUND" : "NOT FOUND")), n(`Coupon Remove Chips: ${o.length} found`), n("=== END COUPON TEST ===") }, e("Cart deposit blocks script with coupon support loaded"), n("Cart blocks with coupon support fully initialized") }();